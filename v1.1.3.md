# v1.1.3 — Memory Leak Fix

**Released:** February 23, 2026

## What Changed

Fixed a memory leak in the `Simulator` class introduced in v1.1.1's performance optimizations.

## The Bug

The `beforeViolationsCache` optimization (added in v1.1.1 to avoid redundant `diagnose()` calls) never evicted old entries. In long-running economy simulations, this caused unbounded memory growth:

```typescript
// v1.1.1 - v1.1.2 (memory leak)
private beforeViolationsCache = new Map<number, Set<string>>();
```

Each tick added one entry to the cache (tick → Set of violated principle IDs), but entries were never removed. After 1,000 ticks = 1,000 cached entries. After 10,000 ticks = 10,000 cached entries. Indefinitely.

## The Fix

Clear stale cache entries when moving to a new tick:

```typescript
// v1.1.3 (bounded cache)
const tick = currentMetrics.tick;
if (this.beforeViolationsCache.size > 0 && !this.beforeViolationsCache.has(tick)) {
  this.beforeViolationsCache.clear();
}
```

Now the cache holds **at most 1 entry** at any time (the current tick). When the simulation advances to a new tick, the old entry is evicted.

## Performance Impact

**Before (v1.1.2):**
- ✅ 1 `diagnose()` call per tick (good)
- ❌ Unbounded memory growth (bad)

**After (v1.1.3):**
- ✅ 1 `diagnose()` call per tick (still good)
- ✅ Bounded to 1 cache entry (fixed)

The performance optimization is preserved, the memory leak is eliminated.

## When This Matters

- **Short simulations (< 100 ticks):** Negligible impact
- **Medium simulations (100-1000 ticks):** ~60KB-600KB leaked memory
- **Long simulations (10,000+ ticks):** Multi-MB leak, eventual crash

If you're running AgentE in production on a live economy (persistent world, long-running server), this fix prevents memory exhaustion over days/weeks of operation.

## Testing

All 44 tests passing ✓

## Credits

Discovered by nightly automated code review (PR #2).

---

**Upgrade:**
```bash
npm install @agent-e/core@1.1.3
```
